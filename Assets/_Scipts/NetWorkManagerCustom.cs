using UnityEngine;
using System.Collections;
using UnityEngine.Networking;
using UnityEngine.UI;
using System;
using System.IO;
using UnityEngine.SceneManagement;

////////////////////////////////////////////////////////////////////////////////////////////
// Script perméttant la connection en réseau des devices
// UNET Unity5
////////////////////////////////////////////////////////////////////////////////////////////

public class NetWorkManagerCustom : NetworkManager{
	
	public Text errorMessage;
    public string ip;

    public InputField _inputField;
    public string myIp;

    void Start()
    {
        var ipaddress = Network.player.ipAddress;
        myIp = ipaddress;
        _inputField.GetComponent<InputField>().text = PlayerPrefs.GetString("ipServer");
    }

    void Update()
    {
      if (_inputField)
        ip = _inputField.GetComponent<InputField>().text;
    }

    public void startServer()
    {
        SetPort();
        NetworkManager.singleton.StartServer();
        ChangeSceneTo(1);
    }

    ////////////////////////////////////////////////////////////////////////////////////////////
	// Afficher un message d'erreur pendant un temp donné
    ////////////////////////////////////////////////////////////////////////////////////////////
	IEnumerator displayErrorMessage(string message, float time)
	{
			errorMessage.text = message;
			yield return new WaitForSeconds(time);
	}
	
    ////////////////////////////////////////////////////////////////////////////////////////////
	// Démarrer le serveur et s'y connecte comme client sur la page de gestion administrateur
    // Se connecter en tant que Host : Server+Client
    ////////////////////////////////////////////////////////////////////////////////////////////
	public void StartupHost()
	{
            SetPort();
            NetworkManager.singleton.StartHost();
	}

    ////////////////////////////////////////////////////////////////////////////////////////////
	// Se connecter au serveur comme client
    ////////////////////////////////////////////////////////////////////////////////////////////
	public void Join()
	{
		SetIPAdress();
		SetPort();
		NetworkManager.singleton.StartClient();
      //  ChangeSceneTo(2);
	}

    ////////////////////////////////////////////////////////////////////////////////////////////
	//Addresse Ip du Pc distant
    ////////////////////////////////////////////////////////////////////////////////////////////
	void SetIPAdress()
	{
        //NetworkManager.singleton.networkAddress = "localhost";
        PlayerPrefs.SetString("ipServer", ip);
        PlayerPrefs.Save();
        NetworkManager.singleton.networkAddress = ip;
	}

    ////////////////////////////////////////////////////////////////////////////////////////////
	// Port utilisé par défaut
    ////////////////////////////////////////////////////////////////////////////////////////////
	void SetPort()
	{
		NetworkManager.singleton.networkPort = 7777;
	}
	
	
	////////////////////////////////////////////////////////////////////////////////////////////
	// Permet de changer de scene
	////////////////////////////////////////////////////////////////////////////////////////////
	public void ChangeSceneTo(int scene)
	{
        SceneManager.LoadScene(scene);
	}
}
